#!/bin/bash
#
# requires:
#  bash
#
set -e
set -o pipefail

function vdc_origin_url(){
  (cd ${vdc_dir} && git config --get remote.origin.url)
}

function update_vdc(){
  sync_repo ${vdc_repo_url} ${vdc_build_target:-${vdc_branch}} ${vdc_dir}
}

function sync_repo(){
  local repo_url=${1} target=${2} destination=${3}
  [[ $# -eq 3 ]] || { echo "[ERROR] Wrong number of arguments $# for 3" >&2; return 1; }
  local revision=${target}
  cd ${destination}
  [[ "${target}" =~ ^[0-9a-f]{40}$ ]] || {
    revision=$(git ls-remote ${repo_url} ${target} | egrep "[0-9a-f]{40}[[:space:]]+refs/.*?/${target}" | cut -c1-40)
  }

  git fetch origin
  git fetch --tags origin
  git reset --hard ${revision}
  git submodule update --init
}

function prepare(){
  vdc_repo_url=$(vdc_origin_url)
}

function rpmbuild(){
  cd ${lib_dir}
  ./spot-build.sh ${vdc_dir} ${vdc_branch}
}

function load_config(){
  [[ ! -f ${config_dir}/kemumaki.conf ]] || . ${config_dir}/kemumaki.conf
}

function set_debug(){
  [[ ${KEMUMAKI_DEBUG:-${debug}} = true ]] && set -x || :
}

function initialize(){
  abs_dirname=$(cd $(dirname ${BASH_SOURCE[0]})/../ && pwd)
  lib_dir=${abs_dirname}/lib
  config_dir=${KEMUMAKI_CONFIG_DIR:-${abs_dirname}/config}
  load_config
  set_debug

  vdc_build_target=${vdc_build_target:-}
  tmp_dir=${abs_dirname}/tmp
  rpmbuild_tmp_dir=${tmp_dir}/rpmbuild

  # kemumaki
  kemumaki_repo_url=${kemumaki_repo_url:-https://github.com/axsh/kemumaki.git}
  kemumaki_branch=${KEMUMAKI_BRANCH:-${kemumaki_branch:-master}}

  # vdc
  vdc_repo_url=${VDC_REPO_URL:-${vdc_repo_url:-https://github.com/axsh/wakame-vdc.git}}
  vdc_branch=${GIT_BRANCH:-${vdc_branch:-master}}
  vdc_branch=${vdc_branch##*/} # remote/feathre-foo -> feature-foo
  vdc_dir=${VDC_DIR:-${WORKSPACE:-${vdc_dir:-${abs_dirname}/wakame-vdc}}}

  mkdir -p ${tmp_dir}
  mkdir -p ${rpmbuild_tmp_dir}
}

LANG=C
LC_ALL=C

initialize

command=${1:-""}

prepare

case "${command}" in
  rpmbuild)
    rpmbuild
    ;;
  *)
    echo "[ERROR] no such command: ${command}" >&2
    exit 1
    ;;
esac
